<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Post Editor - Gisu Safaris</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f7fb; }
    .card { border:0; box-shadow:0 4px 14px rgba(0,0,0,.06); }
    textarea { min-height: 200px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">Gisu Safaris Admin</a>
      <span class="navbar-text">Post Editor</span>
      <div class="ms-auto">
        <button id="logoutBtn" class="btn btn-sm btn-outline-danger">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="row g-3">
      <div class="col-12">
        <div class="alert alert-info">Admin-only editor. You are logged in.</div>
      </div>

      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Slug</label>
                <input id="slug" class="form-control mono" placeholder="e.g. uganda-safari-itinerary" />
                <div class="form-text">Lowercase, hyphens only. URL: /blog/post.html?slug=your-slug</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Status</label>
                <select id="status" class="form-select">
                  <option value="published" selected>published</option>
                  <option value="draft">draft</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label">Title</label>
                <input id="title" class="form-control" />
              </div>
              <div class="col-md-12">
                <label class="form-label">Summary</label>
                <textarea id="summary" class="form-control" placeholder="Short excerpt shown in lists"></textarea>
              </div>
              <div class="col-md-12">
                <label class="form-label">Hero Image URL</label>
                <input id="hero" class="form-control" placeholder="/images/blog/your-image.jpg" />
              </div>
              <div class="col-md-12">
                <label class="form-label">Content (HTML)</label>
                <textarea id="content" class="form-control mono" placeholder="<p>Your article content...</p>"></textarea>
                <div class="form-text">You can paste HTML from a rich editor. Ensure headings and paragraphs are well-formed.</div>
              </div>
              <div class="col-12 d-flex gap-2">
                <button id="saveBtn" class="btn btn-primary">Save Post</button>
                <button id="previewBtn" class="btn btn-outline-primary">Open Preview</button>
              </div>
              <div class="col-12">
                <div id="result" class="mt-2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = '/backend/api/posts.php';
    const AUTH = '/backend/api/auth.php';
    function $(s){ return document.querySelector(s); }

    async function savePost(){
      const payload = {
        slug: $('#slug').value.trim().toLowerCase(),
        title: $('#title').value.trim(),
        summary: $('#summary').value.trim(),
        hero_image: $('#hero').value.trim(),
        content_html: $('#content').value,
        status: $('#status').value
      };
      if (!payload.slug || !payload.title || !payload.content_html) {
        $('#result').innerHTML = '<div class="alert alert-warning">Slug, Title and Content are required.</div>';
        return;
      }
      const res = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok || !json?.success) {
        $('#result').innerHTML = '<div class="alert alert-danger">Failed to save: ' + (json.message||'') + '</div>';
        return;
      }
      $('#result').innerHTML = '<div class="alert alert-success">Saved! <a href="/blog/post.html?slug=' + encodeURIComponent(payload.slug) + '" target="_blank">Open</a></div>';
    }

    async function requireSession(){
      try {
        const r = await fetch(AUTH, { headers: { 'Accept': 'application/json' } });
        const j = await r.json();
        if (!j?.success || !j?.data?.me?.is_admin) {
          window.location.href = '/backend/admin/login.html';
        }
      } catch {
        window.location.href = '/backend/admin/login.html';
      }
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await requireSession();
      $('#saveBtn').addEventListener('click', savePost);
      $('#previewBtn').addEventListener('click', ()=>{
        const slug = $('#slug').value.trim();
        if (!slug) { alert('Enter slug first'); return; }
        window.open('/blog/post.html?slug=' + encodeURIComponent(slug), '_blank');
      });
      document.getElementById('logoutBtn').addEventListener('click', async ()=>{
        await fetch(AUTH, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'logout' }) });
        window.location.href = '/backend/admin/login.html';
      });
    });
  </script>
</body>
</html>
