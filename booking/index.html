<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking - Gisu Safaris</title>
  <meta name="description" content="Secure your Gisu Safaris booking. Choose dates, provide traveler details, and pay deposit or full amount." />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="icon" href="images/logo-gisu-safaris.png" type="image/svg+xml">
  <link rel="alternate icon" href="https://gisusafaris.com/img/gisu_safaris.png" type="image/png">
  <link rel="apple-touch-icon" href="https://gisusafaris.com/img/gisu_safaris.png">
  <!-- Optional JS fallback with full catalog for file:// contexts -->
  <script src="catalog.js"></script>
  <style>
    body { padding-top: 72px; }
    .step { display: none; }
    .step.active { display: block; }
    .small-muted { font-size: 0.9rem; color: #6c757d; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold d-flex align-items-center" href="../index.html">
        <img src="https://gisusafaris.com/img/gisu_safaris.png" alt="Gisu Safaris Logo" height="40" class="me-2" />
        <span>Gisu Safaris</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav"></div>
    </div>
  </nav>

  <main class="py-4">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 mx-auto">
          <h1 class="h3 mb-3">Complete Your Booking</h1>
          <div class="alert alert-info" id="pkgSummary" role="alert">
            <div><strong>Selection:</strong> <span id="pkgTitle">—</span> <span class="small-muted" id="summaryType"></span></div>
            <div><strong>Base Price (per person):</strong> $<span id="pkgAmount">0</span></div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <!-- Step 0: Choose booking type and item -->
              <section class="step" id="step0">
                <h5 class="mb-3">0) What would you like to book?</h5>
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label">Booking Type</label>
                    <div class="d-flex gap-4">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="bookingType" id="typeSafari" value="safari" checked>
                        <label class="form-check-label" for="typeSafari">Safari Package</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="bookingType" id="typeService" value="service">
                        <label class="form-check-label" for="typeService">Service</label>
                      </div>
                    </div>
                  </div>

                  <div class="col-12" id="safariSelectWrap">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Country</label>
                        <select class="form-select" id="safariCountry">
                          <option value="" selected>Choose a country…</option>
                          <!-- options will be populated dynamically from catalog (plus 'All') -->
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Safari Package</label>
                        <select class="form-select" id="safariPackage">
                          <option value="" selected>Choose a package…</option>
                        </select>
                        <div class="form-text">You can also enter a custom title and amount below.</div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6 d-none" id="serviceSelectWrap">
                    <label class="form-label">Service</label>
                    <select class="form-select" id="serviceSelect">
                      <option value="" selected>Choose a service…</option>
                      <option value="hotel-reservation">Hotel Reservation</option>
                      <option value="air-ticketing">Air Ticketing</option>
                      <option value="car-hire">Car Hire</option>
                      <option value="travel-insurance">Travel Insurance</option>
                      <option value="visa-processing">Visa Processing</option>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="customTitle" placeholder="e.g. Custom Safari or Service" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Base Price (per person)</label>
                    <input type="number" min="0" step="0.01" class="form-control" id="customAmount" placeholder="e.g. 1200" />
                    <div class="form-text">For services, enter the estimated per-person price if applicable.</div>
                  </div>
                </div>
                <div class="d-flex justify-content-end mt-4">
                  <button class="btn btn-primary" id="toStep1">Continue</button>
                </div>
              </section>

              <!-- Step 1: Trip details -->
              <section class="step active" id="step1">
                <h5 class="mb-3">1) Trip details</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" required />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" required />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Travelers</label>
                    <input type="number" min="1" value="1" class="form-control" id="travelers" required />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Pickup Location (optional)</label>
                    <input type="text" class="form-control" id="pickup" placeholder="Hotel / Airport" />
                  </div>
                </div>
                <div class="d-flex justify-content-end mt-4">
                  <button class="btn btn-primary" id="toStep2">Next</button>
                </div>
              </section>

              <!-- Step 2: Traveler info -->
              <section class="step" id="step2">
                <h5 class="mb-3">2) Traveler information</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="fullName" required />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="phone" required inputmode="tel" autocomplete="tel"
                           placeholder="e.g. +14155552671" pattern="^\+?[1-9]\d{7,14}$"
                           title="Enter a valid phone in international format, e.g. +14155552671 (8–15 digits)." />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" required autocomplete="email"
                           pattern="^[^\s@]+@[^\s@]+\.[^\s@]{2,}$" title="Enter a valid email like name@example.com" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Nationality</label>
                    <input type="text" class="form-control" id="nationality" required
                           pattern="^[A-Za-z\s]{2,56}$"
                           title="Enter a valid nationality (letters/spaces only)." />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Passport</label>
                    <input type="text" class="form-control" id="passport" inputmode="text" maxlength="9" required
                           placeholder="8–9 characters" pattern="^[A-Za-z0-9]{8,9}$"
                           title="Passport should be 8–9 letters/numbers (no spaces)." />
                  </div>
                  <div class="col-12">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-control" id="notes" rows="3" placeholder="Any special requests"></textarea>
                  </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                  <button class="btn btn-outline-secondary" id="backTo1">Back</button>
                  <button class="btn btn-primary" id="toStep3">Next</button>
                </div>
              </section>

              <!-- Step 3: Review & payment -->
              <section class="step" id="step3">
                <h5 class="mb-3">3) Review & Payment</h5>
                <div class="border rounded p-3 mb-3">
                  <div class="row">
                    <div class="col-md-6">
                      <div><strong>Dates:</strong> <span id="reviewDates">—</span></div>
                      <div><strong>Travelers:</strong> <span id="reviewTravelers">1</span></div>
                    </div>
                    <div class="col-md-6">
                      <div><strong>Per Person:</strong> $<span id="reviewPerPerson">0</span></div>
                      <div><strong>Total:</strong> $<span id="reviewTotal">0</span></div>
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Choose Payment</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="payChoice" id="payDeposit" checked />
                    <label class="form-check-label" for="payDeposit">
                      Pay 70% Deposit now — $<span id="depositAmount">0</span>
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="payChoice" id="payFull" />
                    <label class="form-check-label" for="payFull">
                      Pay Full Amount now — $<span id="fullAmount">0</span>
                    </label>
                  </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button class="btn btn-outline-secondary" id="backTo2">Back</button>
                  <button class="btn btn-success" id="confirmPay">
                    <i class="fas fa-credit-card me-2"></i>Proceed to Payment
                  </button>
                </div>
              </section>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="../js/payment.js"></script>
  <script>
    (function(){
      const params = new URLSearchParams(location.search);
      let bookingType = (params.get('bookingType') === 'service') ? 'service' : 'safari';
      let packageId = params.get('packageId') || 'custom';
      let title = params.get('title') || 'Gisu Safaris Booking';
      let amount = parseFloat(params.get('amount') || '0') || 0;
      const serviceIdParam = params.get('serviceId') || '';
      // Lock service controls when user clicked a preselected plan/button (has title/amount or serviceId)
      let lockService = (bookingType === 'service') && (params.has('title') || params.has('amount') || params.has('serviceId'));

      // 70% deposit rule
      const depositRate = 0.7;

      // Elements
      const pkgTitle = document.getElementById('pkgTitle');
      const pkgAmount = document.getElementById('pkgAmount');
      const summaryType = document.getElementById('summaryType');
      const reviewPerPerson = document.getElementById('reviewPerPerson');
      const reviewTotal = document.getElementById('reviewTotal');
      const depositAmountEl = document.getElementById('depositAmount');
      const fullAmountEl = document.getElementById('fullAmount');
      const reviewDates = document.getElementById('reviewDates');
      const reviewTravelers = document.getElementById('reviewTravelers');

      // Step 0 controls
      const step0 = document.getElementById('step0');
      const typeSafari = document.getElementById('typeSafari');
      const typeService = document.getElementById('typeService');
      const safariSelectWrap = document.getElementById('safariSelectWrap');
      const safariCountry = document.getElementById('safariCountry');
      const safariPackage = document.getElementById('safariPackage');
      const serviceSelectWrap = document.getElementById('serviceSelectWrap');
      const serviceSelect = document.getElementById('serviceSelect');
      const customTitle = document.getElementById('customTitle');
      const customAmount = document.getElementById('customAmount');

      // Catalogs and price maps (moved into script)
      let safariCatalog = {
        uganda: [
          { id: 'gorilla-5d', title: 'Gorilla Trekking Safari - Bwindi (5 Days)', amount: 1200 },
          { id: 'murchison-4d', title: 'Murchison Falls Wildlife (4 Days)', amount: 800 },
          { id: 'queen-4d', title: 'Queen Elizabeth Park (4 Days)', amount: 950 }
        ],
        kenya: [
          { id: 'masai-5d', title: 'Masai Mara Classic (5 Days)', amount: 1400 }
        ],
        tanzania: [
          { id: 'serengeti-5d', title: 'Serengeti Explorer (5 Days)', amount: 1500 }
        ],
        rwanda: [
          { id: 'volcanoes-3d', title: 'Volcanoes NP Gorillas (3 Days)', amount: 1300 }
        ]
      };

      let servicePrices = {
        'hotel-reservation': 450,
        'air-ticketing': 300,
        'car-hire': 120,
        'travel-insurance': 60,
        'visa-processing': 100
      };

      function populateCountries() {
        if (!safariCountry) return;
        // Preserve first placeholder option
        const placeholder = safariCountry.querySelector('option[value=""]') || (() => {
          const opt = document.createElement('option');
          opt.value = '';
          opt.selected = true;
          opt.textContent = 'Choose a country…';
          return opt;
        })();
        safariCountry.innerHTML = '';
        safariCountry.appendChild(placeholder);
        const allOpt = document.createElement('option');
        allOpt.value = 'all';
        allOpt.textContent = 'All Countries';
        safariCountry.appendChild(allOpt);
        Object.keys(safariCatalog).sort().forEach(k => {
          if (Array.isArray(safariCatalog[k]) && safariCatalog[k].length) {
            const opt = document.createElement('option');
            opt.value = k;
            opt.textContent = k.charAt(0).toUpperCase() + k.slice(1);
            safariCountry.appendChild(opt);
          }
        });
      }

      function populateSafariPackages(country){
        // Clear
        safariPackage.innerHTML = '<option value="" selected>Choose a package…</option>';
        let list = [];
        if (!country) return;
        if (country === 'all') {
          for (const k in safariCatalog) { if (Array.isArray(safariCatalog[k])) list = list.concat(safariCatalog[k]); }
        } else if (safariCatalog[country]) {
          list = safariCatalog[country];
        }
        list.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = `${p.title} — $${p.amount}`;
          opt.setAttribute('data-amount', String(p.amount));
          safariPackage.appendChild(opt);
        });
      }

      // If JS fallback loaded first, prefer it
      if (window.__SAFARI_CATALOG__) {
        safariCatalog = window.__SAFARI_CATALOG__;
        if (window.__SERVICE_PRICES__) servicePrices = window.__SERVICE_PRICES__;
      }
      // Populate countries immediately from current catalog (works offline or if fetch fails)
      populateCountries();

      // Attempt to fetch dynamic catalog (booking/catalog.json). Graceful fallback to built-in.
      (async () => {
        try {
          const resp = await fetch('catalog.json', { cache: 'no-store' });
          if (resp.ok) {
            const data = await resp.json();
            if (data && typeof data === 'object') {
              if (data.safariCatalog && typeof data.safariCatalog === 'object') {
                safariCatalog = data.safariCatalog;
              }
              if (data.servicePrices && typeof data.servicePrices === 'object') {
                servicePrices = data.servicePrices;
              }
              // Re-populate country dropdown from loaded catalog
              populateCountries();
              // If a country is already selected (or from params), re-populate packages
              if (safariCountry && safariCountry.value) {
                populateSafariPackages(safariCountry.value);
              }
            }
          }
        } catch {
          // On failure, ensure countries are still available from built-in catalog
          if (window.__SAFARI_CATALOG__) {
            safariCatalog = window.__SAFARI_CATALOG__;
            if (window.__SERVICE_PRICES__) servicePrices = window.__SERVICE_PRICES__;
          }
          populateCountries();
        }
      })();

      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');
      const travelers = document.getElementById('travelers');
      const pickup = document.getElementById('pickup');

      const fullName = document.getElementById('fullName');
      const phone = document.getElementById('phone');
      const email = document.getElementById('email');
      const nationality = document.getElementById('nationality');
      const passport = document.getElementById('passport');
      const notes = document.getElementById('notes');

      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');

      // Initialize summary
      function refreshSummary(){
        pkgTitle.textContent = title;
        pkgAmount.textContent = amount.toFixed(2);
        summaryType.textContent = bookingType ? `(${bookingType})` : '';
        reviewPerPerson.textContent = amount.toFixed(2);
        fullAmountEl.textContent = amount.toFixed(2);
        depositAmountEl.textContent = (amount * depositRate).toFixed(2);
      }
      refreshSummary();

      function go(step){
        [step1, step2, step3].forEach(s => s.classList.remove('active'));
        step.classList.add('active');
      }

      // Show Step 0 if no explicit title/amount provided (general booking entry)
      // Always show Step 0 first so users can choose Safari Package or Service.
      // If URL params exist, we prefill but still let the user change.
      step0.classList.add('active');
      step1.classList.remove('active');

      // Prefill from URL (without forcing progression)
      if (params.has('bookingType')) {
        if (bookingType === 'service') {
          typeService.checked = true;
        } else {
          typeSafari.checked = true;
        }
        updateTypeUI();
      }
      if (params.has('title')) {
        customTitle.value = title;
      }
      if (params.has('amount')) {
        customAmount.value = amount.toString();
      }
      // If arriving with a preselected service plan, set service value and disable controls
      if (lockService) {
        // Show service selector block (in case it was hidden)
        safariSelectWrap.classList.add('d-none');
        serviceSelectWrap.classList.remove('d-none');
        // Try to select matching service option
        if (serviceIdParam) {
          const idx = Array.from(serviceSelect.options).findIndex(o => o.value === serviceIdParam);
          if (idx >= 0) serviceSelect.selectedIndex = idx;
          packageId = serviceIdParam;
        } else {
          packageId = 'service-custom';
        }
        // Disable service and amount editing to keep the chosen plan intact
        serviceSelect.setAttribute('disabled', 'disabled');
        customAmount.setAttribute('disabled', 'disabled');
        serviceSelect.title = 'Disabled: plan preselected from previous page';
        customAmount.title = 'Disabled: price set by selected plan';
      }
      if (params.has('packageId') && bookingType === 'safari') {
        // find package across all countries
        const targetId = packageId;
        let foundCountry = '';
        for (const c in safariCatalog) {
          if (safariCatalog[c].some(p => p.id === targetId)) { foundCountry = c; break; }
        }
        if (foundCountry) {
          safariCountry.value = foundCountry;
          populateSafariPackages(foundCountry);
          const idx = Array.from(safariPackage.options).findIndex(o => o.value === targetId);
          if (idx >= 0) {
            safariPackage.selectedIndex = idx;
            const opt = safariPackage.options[idx];
            const amt = parseFloat(opt.getAttribute('data-amount') || '0') || 0;
            amount = amt;
            title = opt.textContent.replace(/\s—\s\$.*$/, '');
            refreshSummary();
          }
        }
      }

      // Toggle UI on type switch
      function updateTypeUI(){
        bookingType = typeService.checked ? 'service' : 'safari';
        if (bookingType === 'safari') {
          safariSelectWrap.classList.remove('d-none');
          serviceSelectWrap.classList.add('d-none');
        } else {
          safariSelectWrap.classList.add('d-none');
          serviceSelectWrap.classList.remove('d-none');
        }
      }
      typeSafari.addEventListener('change', updateTypeUI);
      typeService.addEventListener('change', updateTypeUI);
      updateTypeUI();

      // Country -> populate packages
      safariCountry.addEventListener('change', () => {
        populateSafariPackages(safariCountry.value);
        // reset selection
        packageId = 'custom';
        title = 'Gisu Safaris Booking';
        amount = 0;
        refreshSummary();
      });

      // Selecting a package sets title/amount
      safariPackage.addEventListener('change', () => {
        const opt = safariPackage.options[safariPackage.selectedIndex];
        if (opt && opt.value) {
          packageId = opt.value;
          const amt = parseFloat(opt.getAttribute('data-amount') || '0') || 0;
          amount = amt;
          title = opt.textContent.replace(/\s—\s\$.*$/, '');
          refreshSummary();
        }
      });

      // Service selection sets default price when known
      serviceSelect.addEventListener('change', () => {
        const v = serviceSelect.value;
        if (v) {
          const known = servicePrices[v];
          if (typeof known === 'number') {
            amount = known;
            customAmount.value = String(known);
          }
          const sel = serviceSelect.options[serviceSelect.selectedIndex];
          title = sel ? sel.textContent : 'Service Booking';
          refreshSummary();
        }
      });

      // Continue from Step 0
      document.getElementById('toStep1').addEventListener('click', () => {
        // If custom provided, prefer that
        const custTitle = (customTitle.value || '').trim();
        const custAmount = parseFloat(customAmount.value || 'NaN');
        if (custTitle) title = custTitle;
        if (!Number.isNaN(custAmount)) amount = Math.max(0, custAmount);

        if (bookingType === 'safari') {
          // Require either a selected country+package or a custom title
          const country = safariCountry.value;
          const pkgVal = safariPackage.value;
          if ((!country || !pkgVal) && !custTitle) {
            alert('Please choose a country and safari package, or enter a custom title.');
            return;
          }
          if (pkgVal) {
            const opt = safariPackage.options[safariPackage.selectedIndex];
            packageId = pkgVal;
            const amt = parseFloat(opt.getAttribute('data-amount') || '0') || 0;
            amount = amt; // enforce auto-pricing
            title = opt.textContent.replace(/\s—\s\$.*$/, '');
          }
        } else {
          // Service: require a selection or custom title
          if (!lockService) {
            if (!serviceSelect.value && !custTitle) {
              alert('Please choose a service or enter a custom title.');
              return;
            }
          }
          if (!custTitle) {
            const sel = serviceSelect.options[serviceSelect.selectedIndex];
            title = sel ? sel.textContent : 'Service Booking';
          }
          packageId = lockService ? (serviceIdParam || 'service-custom') : (serviceSelect.value || 'service-custom');
          // If known price exists, enforce it
          const key = lockService ? serviceIdParam : serviceSelect.value;
          const known = servicePrices[key];
          if (typeof known === 'number' && !params.has('amount')) {
            // Only override if URL didn't provide an explicit amount
            amount = known;
            customAmount.value = String(known);
          }
        }
        refreshSummary();
        // Proceed to trip details
        step0.classList.remove('active');
        go(step1);
      });

      document.getElementById('toStep2').addEventListener('click', () => {
        if (!startDate.value || !endDate.value || !travelers.value) return alert('Please fill dates and number of travelers.');
        go(step2);
      });
      document.getElementById('backTo1').addEventListener('click', () => go(step1));

      // Helpers: validation and sanitization
      const E164 = /^\+?[1-9]\d{7,14}$/;
      function sanitizePhoneInput(v){
        // Keep digits and '+' only; only one '+' at start
        v = v.replace(/[^\d+]/g, '');
        v = v.replace(/(?!^)\+/g, '');
        if (v.includes('+') && v[0] !== '+') v = '+' + v.replace(/\+/g, '');
        return v;
      }
      function westernPhoneLengthOk(v){
        // v is sanitized; check common Western codes for plausible lengths (digits only count)
        const digits = v.replace(/\D/g, '');
        const starts = v.startsWith('+') ? v : '+' + digits;
        const len = digits.length; // includes country code
        // Map: code -> allowed total digit length (E.164, without '+') ranges
        const ranges = [
          { code: '+1', min: 11, max: 11 },     // US/CA
          { code: '+44', min: 11, max: 12 },    // UK
          { code: '+33', min: 11, max: 11 },    // FR
          { code: '+49', min: 11, max: 13 },    // DE
          { code: '+39', min: 11, max: 12 },    // IT
          { code: '+31', min: 11, max: 11 },    // NL
          { code: '+61', min: 11, max: 11 },    // AU
          { code: '+353', min: 12, max: 12 },   // IE
          { code: '+34', min: 11, max: 11 },    // ES
          { code: '+41', min: 11, max: 11 }     // CH
        ];
        const match = ranges.find(r => starts.startsWith(r.code));
        if (!match) return E164.test(v); // default to E.164
        return len >= match.min && len <= match.max;
      }

      // Live input sanitizers
      phone.addEventListener('input', () => {
        const cur = phone.value;
        const sanitized = sanitizePhoneInput(cur);
        if (cur !== sanitized) phone.value = sanitized;
      });
      fullName.addEventListener('input', () => {
        // Keep letters, spaces, hyphen, apostrophe
        const cleaned = fullName.value.replace(/[^A-Za-z'\-\s]/g, '');
        if (cleaned !== fullName.value) fullName.value = cleaned;
      });
      passport.addEventListener('input', () => {
        let v = passport.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (v.length > 9) v = v.slice(0,9);
        if (passport.value !== v) passport.value = v;
      });
      nationality.addEventListener('input', () => {
        let v = nationality.value.replace(/[^A-Za-z\s]/g, '');
        if (v.length > 56) v = v.slice(0,56);
        if (v !== nationality.value) nationality.value = v;
      });

      function validateContactFields(){
        // Name
        const nameVal = fullName.value.trim();
        if (!nameVal) { fullName.focus(); return 'Full name is required.'; }
        // Require at least two words, letters/'- and reasonable length
        const nameParts = nameVal.split(/\s+/).filter(Boolean);
        const nameCharOk = /^[A-Za-z'\-\s]{2,60}$/.test(nameVal);
        const noDigit = !/[0-9]/.test(nameVal);
        const noConsonantRuns = !/(?:[^AEIOUaeiou\W]){4,}/.test(nameVal); // 4+ consonants in a row looks fake
        if (nameParts.length < 2 || !nameCharOk || !noDigit || !noConsonantRuns) {
          fullName.focus();
          return 'Enter a real full name (first and last), letters only (hyphen/apostrophe allowed).';
        }
        // Email
        const emailVal = email.value.trim();
        const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(emailVal);
        if (!emailOk) { email.focus(); return 'Please enter a valid email like name@example.com.'; }
        // Email heuristic: reject likely gibberish local-parts (too few vowels when letters-only)
        const [localPart] = emailVal.split('@');
        if (/^[A-Za-z]+$/.test(localPart)) {
          const vowels = (localPart.match(/[AEIOUaeiou]/g) || []).length;
          const consonantRuns = /(?:[^AEIOUaeiou]){3,}/.test(localPart);
          if (vowels < 3 || consonantRuns) {
            email.focus();
            return 'Please provide a professional email (local part looks random).';
          }
        }
        // Phone
        const phoneVal = sanitizePhoneInput(phone.value.trim());
        phone.value = phoneVal;
        if (!E164.test(phoneVal)) { phone.focus(); return 'Enter phone in international format, e.g. +14155552671 (8–15 digits).'; }
        if (!westernPhoneLengthOk(phoneVal)) { phone.focus(); return 'Phone number length does not match the selected country code.'; }
        // Passport: required 8–9 alphanumeric
        const passVal = passport.value.trim();
        if (!/^[A-Z0-9]{8,9}$/.test(passVal)) { passport.focus(); return 'Passport is required (8–9 letters/numbers only).'; }
        // Nationality: required letters/spaces and no long consonant runs
        const natVal = (nationality.value || '').trim();
        if (!/^[A-Za-z\s]{2,56}$/.test(natVal) || /(?:[^AEIOUaeiou\W]){4,}/.test(natVal)) {
          nationality.focus();
          return 'Nationality is required and must be letters/spaces only.';
        }
        return '';
      }

      document.getElementById('toStep3').addEventListener('click', () => {
        const err = validateContactFields();
        if (err) { alert(err); return; }
        reviewDates.textContent = `${startDate.value} to ${endDate.value}`;
        reviewTravelers.textContent = travelers.value;
        const total = amount * Number(travelers.value || 1);
        reviewTotal.textContent = total.toFixed(2);
        fullAmountEl.textContent = total.toFixed(2);
        depositAmountEl.textContent = (total * depositRate).toFixed(2);
        go(step3);
      });
      document.getElementById('backTo2').addEventListener('click', () => go(step2));

      document.getElementById('confirmPay').addEventListener('click', async () => {
        const err = validateContactFields();
        if (err) { alert(err); return; }
        const total = amount * Number(travelers.value || 1);
        const payDeposit = document.getElementById('payDeposit').checked;
        const payAmount = payDeposit ? (total * depositRate) : total;

        const customer = { name: fullName.value.trim(), email: email.value.trim(), phone: phone.value.trim() };
        const metadata = {
          packageId,
          title,
          startDate: startDate.value,
          endDate: endDate.value,
          travelers: travelers.value,
          pickup: pickup.value,
          nationality: nationality.value,
          passport: passport.value,
          notes: notes.value
        };

        // Create placeholder booking
        try {
          const resp = await fetch('../backend/api/payments/create_placeholder_booking.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bookingType, title, customer, metadata })
          });
          if (!resp.ok) throw new Error(await resp.text());
          const data = await resp.json();
          if (!data || !data.bookingId) throw new Error('No bookingId');

          const url = new URL(location.href);
          url.searchParams.set('status', 'pending_payment');

          await initiatePayment({
            bookingId: data.bookingId,
            bookingType,
            title,
            amount: Number(payAmount.toFixed(2)),
            deposit: payDeposit,
            customer,
            metadata,
            endpoint: '../backend/api/payments/create_checkout.php'
          });
        } catch (e) {
          console.error(e);
          alert('Unable to start payment. Please try again.');
        }
      });

      // If returning from Stripe with status param
      const status = params.get('status');
      if (status) {
        const map = {
          success: { cls: 'alert-success', msg: 'Payment successful. Thank you!' },
          canceled: { cls: 'alert-warning', msg: 'Payment was canceled. You can try again.' },
          pending_payment: { cls: 'alert-info', msg: 'Continue to complete your payment.' }
        };
        const s = map[status] || { cls: 'alert-secondary', msg: `Status: ${status}` };
        const div = document.createElement('div');
        div.className = `alert ${s.cls}`;
        div.textContent = s.msg;
        document.querySelector('.container').prepend(div);
      }
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
